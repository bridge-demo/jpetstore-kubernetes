# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker



resources:
  repositories:
    - repository: self

trigger: none
pr: none

variables:
  githubToken: $(GITHUB_ACCESS_TOKEN)
  dockerUser: $(DOCKER_USER)
  dockerPassword: $(DOCKER_PASSWORD)
  tenantUrl: $(TENANT_URL)
  userId: $(USER_ID)
  userApiKey: $(USER_API_KEY)
  buildToken: $(BUILD_TOKEN)
  testToken: $(TEST_TOKEN)
  deployToken: $(DEPLOY_TOKEN)
  secureToken: $(SECURE_TOKEN)
  dbUser: $(DB_USER)
  dbPassword: $(DB_PASS)
  # kubeConfig: $(KUBE_CONFIG)
  fqdn: $(FQDN)
  dbUrl: $(DB_URL)
  dbName: $(DB_NAME)
  resourceGroup: $(RESOURCE_GROUP)
  

stages:
- stage: Build
  displayName: Build image
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10.12'
        addToPath: true
    - script: |
        echo $(orderNumber) $(fulfillmentId)
      displayName: 'Echo VARS'
    - script: |
        chmod +x ./pipeline-jenkins/pipeline-jenkins.sh
      displayName: 'Make script executable'
    - script: |
        python3 -m pip install --upgrade pip
        python3 -m pip install -r ./petstore-catalog-deployment/requirements.txt
      displayName: 'Install dependencies'
    - script: |
        python3 ./pipeline-python/pipeline-jenkins.py --github-token $(githubToken) --docker-user $(dockerUser) --docker-password $(dockerPassword) --tenant-url $(tenantUrl) --user-id $(userId) --user-api-key $(userApiKey) --build-token $(buildToken) --test-token $(testToken) --deploy-token $(deployToken) --secure-token $(secureToken) --db-user $(dbUser) --db-password $(dbPassword) --fqdn $(fqdn) --db-url $dbUrl --db-name $(dbName) --resource-group $(resourceGroup)
      displayName: 'Run Python script'
